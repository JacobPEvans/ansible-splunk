---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.9"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache Ansible collections
        uses: actions/cache@v5
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('requirements.yml') }}

      - name: Install dependencies
        run: |
          uv pip install --system ansible-lint yamllint ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Run yamllint
        run: |
          yamllint .

      - name: Run ansible-lint
        run: |
          ansible-lint playbooks/ roles/

  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.9"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache Ansible collections
        uses: actions/cache@v5
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('requirements.yml') }}

      - name: Install dependencies
        run: |
          uv pip install --system ansible

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      - name: Create mock Terraform inventory for syntax checks
        run: |
          cp inventory/terraform_inventory.json.example inventory/terraform_inventory.json

      - name: Syntax check deploy.yml
        run: |
          ansible-playbook playbooks/deploy.yml --syntax-check

      - name: Syntax check configure_indexes.yml
        run: |
          ansible-playbook playbooks/configure_indexes.yml --syntax-check

      - name: Syntax check validate.yml
        run: |
          ansible-playbook playbooks/validate.yml --syntax-check

      - name: Syntax check site.yml
        run: |
          ansible-playbook playbooks/site.yml --syntax-check

  verify-inventory:
    name: Verify Inventory Load
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Install Ansible and collections
        run: |
          pip install ansible ansible-core netaddr
          ansible-galaxy collection install ansible.utils

      - name: Verify terraform inventory loads correctly
        env:
          TERRAFORM_INVENTORY_PATH: ${{ github.workspace }}/tests/inventory_load/terraform_inventory.json
        run: |
          ansible-playbook tests/inventory_load/verify_inventory.yml \
            -i inventory/hosts.yml \
            -c local

      - name: Verify example inventory has correct structure
        run: |
          python3 tests/inventory_load/check_example_structure.py
