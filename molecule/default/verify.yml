---
# Molecule verification playbook
# Validates that the Splunk role executed correctly

- name: Verify
  hosts: all
  become: true
  gather_facts: true

  vars:
    # Skip configuration checks in test environment
    splunk_skip_post_install_config: true

  tasks:
    - name: Check Splunk installation directory exists
      ansible.builtin.stat:
        path: /opt/splunk
      register: splunk_dir

    - name: Assert Splunk is installed
      ansible.builtin.assert:
        that:
          - splunk_dir.stat.exists
          - splunk_dir.stat.isdir
        fail_msg: "Splunk installation directory not found at /opt/splunk"

    - name: Check Splunk binary exists
      ansible.builtin.stat:
        path: /opt/splunk/bin/splunk
      register: splunk_binary

    - name: Assert Splunk binary exists
      ansible.builtin.assert:
        that:
          - splunk_binary.stat.exists
        fail_msg: "Splunk binary not found"
      # Skip executable check in test environment with mock binary
      when: not splunk_skip_post_install_config

    - name: Check server.conf exists
      ansible.builtin.stat:
        path: /opt/splunk/etc/system/local/server.conf
      register: server_conf
      when: not splunk_skip_post_install_config

    - name: Assert server.conf configured
      ansible.builtin.assert:
        that:
          - server_conf.stat.exists
        fail_msg: "server.conf not found - Splunk not configured"
      when: not splunk_skip_post_install_config

    - name: Check inputs.conf exists
      ansible.builtin.stat:
        path: /opt/splunk/etc/system/local/inputs.conf
      register: inputs_conf
      when: not splunk_skip_post_install_config

    - name: Assert inputs.conf configured
      ansible.builtin.assert:
        that:
          - inputs_conf.stat.exists
        fail_msg: "inputs.conf not found - inputs not configured"
      when: not splunk_skip_post_install_config

    - name: Check indexes.conf exists
      ansible.builtin.stat:
        path: /opt/splunk/etc/system/local/indexes.conf
      register: indexes_conf
      when: not splunk_skip_post_install_config

    - name: Assert indexes.conf configured
      ansible.builtin.assert:
        that:
          - indexes_conf.stat.exists
        fail_msg: "indexes.conf not found - indexes not configured"
      when: not splunk_skip_post_install_config

    - name: Check web.conf exists
      ansible.builtin.stat:
        path: /opt/splunk/etc/system/local/web.conf
      register: web_conf
      when: not splunk_skip_post_install_config

    - name: Assert web.conf configured
      ansible.builtin.assert:
        that:
          - web_conf.stat.exists
        fail_msg: "web.conf not found - web interface not configured"
      when: not splunk_skip_post_install_config
