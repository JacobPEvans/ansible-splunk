---
# Deploy Splunk via Docker
# Installs Docker, deploys Splunk container with all configuration

- name: Deploy Splunk Docker
  hosts: splunk
  become: true
  gather_facts: true

  tasks:
    - name: Validate required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'SPLUNK_ADMIN_PASSWORD') | length > 0
          - lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0
        fail_msg: >-
          SPLUNK_ADMIN_PASSWORD and SPLUNK_HEC_TOKEN environment variables must be set
          (use: doppler run -- ansible-playbook ...)
      run_once: true
      delegate_to: localhost

    - name: Set Splunk credentials from environment
      ansible.builtin.set_fact:
        splunk_docker_password: "{{ lookup('env', 'SPLUNK_ADMIN_PASSWORD') }}"
        splunk_docker_hec_token: "{{ lookup('env', 'SPLUNK_HEC_TOKEN') }}"
      no_log: true

    - name: Deploy Splunk Docker
      ansible.builtin.include_role:
        name: splunk_docker
