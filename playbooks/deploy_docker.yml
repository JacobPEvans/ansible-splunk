---
# Deploy Splunk Enterprise via Docker container
# This playbook uses the splunk_docker role for containerized deployment
#
# Prerequisites:
# - Doppler secrets loaded (SPLUNK_PASSWORD, SPLUNK_HEC_TOKEN)
# - Terraform inventory synced (./scripts/sync-terraform-inventory.sh)
#
# Usage:
#   doppler run -- uv run ansible-playbook playbooks/deploy_docker.yml

# Load dynamic inventory from Terraform outputs
# This assumes the standard repo layout: playbooks/ and inventory/ are sibling directories.
- name: Load Terraform inventory
  ansible.builtin.import_playbook: ../inventory/load_terraform.yml

- name: Deploy Splunk Enterprise (Docker)
  hosts: splunk
  become: true
  gather_facts: true

  vars:
    splunk_docker_password: "{{ lookup('env', 'SPLUNK_PASSWORD') | mandatory('SPLUNK_PASSWORD environment variable must be set for Splunk Docker password') }}"
    splunk_docker_hec_token: "{{ lookup('env', 'SPLUNK_HEC_TOKEN') | mandatory('SPLUNK_HEC_TOKEN environment variable must be set for Splunk HEC token') }}"

  tasks:
    - name: Deploy Splunk Docker container
      ansible.builtin.include_role:
        name: splunk_docker
