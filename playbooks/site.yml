---
# Main site playbook for Splunk deployment
# This playbook orchestrates the complete deployment workflow

# Load dynamic inventory from Terraform outputs (if available)
- name: Load Terraform inventory
  ansible.builtin.import_playbook: ../inventory/load_terraform.yml

- name: Deploy Splunk
  hosts: splunk
  become: true
  gather_facts: true

  tasks:
    - name: Validate required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'SPLUNK_PASSWORD') | length > 0
          - lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0
        fail_msg: >-
          SPLUNK_PASSWORD and SPLUNK_HEC_TOKEN environment variables must be set
          (use: doppler run -- ansible-playbook ...)
      run_once: true
      delegate_to: localhost

    - name: Set Splunk credentials from environment
      ansible.builtin.set_fact:
        splunk_docker_password: "{{ lookup('env', 'SPLUNK_PASSWORD') }}"
        splunk_docker_hec_token: "{{ lookup('env', 'SPLUNK_HEC_TOKEN') }}"
      no_log: true

    - name: Deploy Splunk Docker
      ansible.builtin.include_role:
        name: splunk_docker

  post_tasks:
    - name: Wait for Splunk to be ready after any restarts
      ansible.builtin.uri:
        url: "{{ 'https' if splunk_docker_web_ssl else 'http' }}://127.0.0.1:{{ splunk_docker_web_port }}/en-US/account/login"
        validate_certs: false
        status_code: 200
      register: splunk_post_health
      until: splunk_post_health.status == 200
      retries: 24
      delay: 10
