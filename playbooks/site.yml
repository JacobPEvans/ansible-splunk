---
# Main site playbook for Splunk deployment
# This playbook orchestrates the complete deployment workflow

# Load dynamic inventory from Terraform outputs (if available)
- name: Load Terraform inventory
  ansible.builtin.import_playbook: ../inventory/load_terraform.yml

- name: Deploy Splunk
  hosts: splunk
  become: true
  gather_facts: true

  tasks:
    - name: Validate required environment variables
      ansible.builtin.assert:
        that:
          - lookup('env', 'SPLUNK_PASSWORD') | length > 0
          - lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0
        fail_msg: >-
          SPLUNK_PASSWORD and SPLUNK_HEC_TOKEN environment variables must be set
          (use: doppler run -- ansible-playbook ...)
      run_once: true
      delegate_to: localhost

    - name: Set Splunk credentials from environment
      ansible.builtin.set_fact:
        splunk_docker_password: "{{ lookup('env', 'SPLUNK_PASSWORD') }}"
        splunk_docker_hec_token: "{{ lookup('env', 'SPLUNK_HEC_TOKEN') }}"
        splunk_docker_mcp_token: "{{ lookup('env', 'SPLUNK_MCP_TOKEN') }}"
      no_log: true

    - name: Deploy Splunk Docker
      ansible.builtin.include_role:
        name: splunk_docker

  post_tasks:
    - name: Wait for Splunk to be ready after any restarts
      ansible.builtin.include_role:
        name: splunk_docker
        tasks_from: wait_for_splunk
