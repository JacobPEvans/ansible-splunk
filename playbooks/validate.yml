---
# Validation playbook to verify Splunk Docker deployment
# Run this after deploy.yml to verify success
#
# Usage:
#   doppler run -- uv run ansible-playbook playbooks/validate.yml

- name: Load Terraform inventory
  ansible.builtin.import_playbook: ../inventory/load_terraform.yml

- name: Validate Splunk Docker deployment
  hosts: splunk
  become: true
  gather_facts: true

  vars_files:
    - ../roles/splunk_docker/defaults/main.yml

  vars:
    validation_results: []

  tasks:
    - name: Set HEC namespace from environment
      ansible.builtin.set_fact:
        splunk_docker_hec_namespace: "{{ lookup('env', 'HEC_NAMESPACE') }}"
      no_log: true

    - name: Derive HEC token values from namespace
      ansible.builtin.set_fact:
        splunk_docker_hec_token_values: >-
          {{ splunk_docker_hec_token_values | default({}) | combine({
            item.name: ('splunk-hec-' + item.name) | uuidv5(splunk_docker_hec_namespace)
          }) }}
      loop: "{{ splunk_docker_indexes }}"
      loop_control:
        label: "{{ item.name }}"
      when: splunk_docker_hec_namespace | length > 0
      no_log: true

    - name: Derive legacy HEC token
      ansible.builtin.set_fact:
        splunk_docker_hec_token_values: >-
          {{ splunk_docker_hec_token_values | default({}) | combine({
            'legacy': ('splunk-hec-legacy') | uuidv5(splunk_docker_hec_namespace)
          }) }}
      when: splunk_docker_hec_namespace | length > 0
      no_log: true

    - name: Fallback to SPLUNK_HEC_TOKEN if no namespace
      ansible.builtin.set_fact:
        splunk_docker_hec_token_values: >-
          {{ {'legacy': lookup('env', 'SPLUNK_HEC_TOKEN')} }}
      when:
        - splunk_docker_hec_namespace | length == 0
        - lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0
      no_log: true

    - name: Check Docker service is running
      ansible.builtin.service_facts:

    - name: Record Docker service status
      ansible.builtin.set_fact:
        validation_results: |
          {% set svc = ansible_facts.services.get('docker.service', {}).get('state') | default('') %}
          {{ validation_results + [{'check': 'Docker service running', 'passed': svc in ['running', 'started']}] }}

    - name: Check Splunk container is running
      community.docker.docker_container_info:
        name: splunk
      register: splunk_container
      failed_when: false

    - name: Record container status
      ansible.builtin.set_fact:
        validation_results: |
          {{ validation_results + [{'check': 'Splunk container running', 'passed': splunk_container.container.State.Running | default(false)}] }}

    - name: Check docker-compose.yml exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_config_dir }}/docker-compose.yml"
      register: compose_file

    - name: Record docker-compose.yml status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'docker-compose.yml exists', 'passed': compose_file.stat.exists}] }}"

    - name: Check HEC port is listening
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_hec_port }}"
        timeout: 5
      register: hec_port
      failed_when: false

    - name: Record HEC port status
      vars:
        hec_check: "HEC port {{ splunk_docker_hec_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': hec_check, 'passed': hec_port.failed is false}] }}

    - name: Check Splunk web interface
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_web_port }}"
        timeout: 5
      register: web_port
      failed_when: false

    - name: Record web interface status
      vars:
        web_check: "Web port {{ splunk_docker_web_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': web_check, 'passed': web_port.failed is false}] }}

    - name: Check management API port is listening
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_mgmt_port }}"
        timeout: 5
      register: mgmt_port
      failed_when: false

    - name: Record management port status
      vars:
        mgmt_check: "Management API port {{ splunk_docker_mgmt_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': mgmt_check, 'passed': mgmt_port.failed is false}] }}


    - name: Test HEC endpoint per index token
      ansible.builtin.uri:
        url: "http://localhost:{{ splunk_docker_hec_port }}/services/collector/event"
        method: POST
        headers:
          Authorization: "Splunk {{ splunk_docker_hec_token_values[item.name] }}"
        body_format: json
        body:
          event: "ansible-validation-test-{{ item.name }}"
          sourcetype: "_json"
          index: "{{ item.name }}"
        status_code: 200
      register: splunk_docker_hec_test
      failed_when: false
      loop: "{{ splunk_docker_indexes }}"
      loop_control:
        label: "{{ item.name }}"
      when: splunk_docker_hec_token_values[item.name] is defined
      no_log: true

    - name: Record HEC POST test results
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'HEC POST (' + item.item.name + ')',
             'passed': (item.status | default(0)) == 200}] }}
      loop: "{{ splunk_docker_hec_test.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: splunk_docker_hec_test is defined and (item.skipped is not defined or not item.skipped)

    - name: Check web.conf exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/system/local/web.conf"
      register: web_conf

    - name: Record web.conf status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'web.conf configured', 'passed': web_conf.stat.exists}] }}"

    - name: Check indexes.conf exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/system/local/indexes.conf"
      register: indexes_conf

    - name: Record indexes.conf status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'indexes.conf configured', 'passed': indexes_conf.stat.exists}] }}"

    - name: Check firewall.sh exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_config_dir }}/firewall.sh"
      register: firewall_script
      when: splunk_docker_firewall_enabled | default(false)

    - name: Record firewall status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'Firewall configured', 'passed': firewall_script.stat.exists}] }}"
      when: splunk_docker_firewall_enabled | default(false)

    - name: Check Splunk ML apps are installed
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/apps/{{ item.dir }}"
      loop:
        - {name: PSC, dir: python_for_scientific_computing, check: 'PSC app installed'}
        - {name: MLTK, dir: Splunk_ML_Toolkit, check: 'MLTK app installed'}
        - {name: DSDL, dir: Splunk_DSDL, check: 'DSDL app installed'}
      loop_control:
        label: "{{ item.name }}"
      register: splunk_docker_ml_app_checks

    - name: Record Splunk ML app installation status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': item.item.check, 'passed': item.stat.exists}] }}
      loop: "{{ splunk_docker_ml_app_checks.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Check MCP Server app is installed
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/apps/splunk-mcp-server"
      register: splunk_docker_mcp_app_check

    - name: Record MCP Server app status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'MCP Server app installed', 'passed': splunk_docker_mcp_app_check.stat.exists}] }}

    - name: Validate MCP Server REST API
      when:
        - splunk_docker_mcp_app_check.stat.exists
        - lookup('env', 'SPLUNK_PASSWORD') | length > 0
      block:
        - name: Check MCP Server REST API responds
          ansible.builtin.uri:
            url: "https://localhost:{{ splunk_docker_mgmt_port }}/services/apps/local/splunk-mcp-server"
            method: GET
            user: admin
            password: "{{ lookup('env', 'SPLUNK_PASSWORD') }}"
            force_basic_auth: true
            validate_certs: false
            status_code: 200
          register: splunk_docker_mcp_api_check
          failed_when: false
          no_log: true

        - name: Record MCP Server API status
          ansible.builtin.set_fact:
            validation_results: >-
              {{ validation_results + [{'check': 'MCP Server REST API responds', 'passed': (splunk_docker_mcp_api_check.status | default(0)) == 200}] }}


    - name: Check Java is accessible in Splunk container
      community.docker.docker_container_exec:
        container: splunk
        command: "{{ splunk_docker_java_container_home }}/bin/java -version"
      register: java_check
      failed_when: false
      when: splunk_docker_java_enabled

    - name: Record Java availability status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'Java accessible in container', 'passed': (java_check.rc | default(1)) == 0}] }}
      when: splunk_docker_java_enabled

    - name: Check DB Connect JAVA_HOME configured in container
      community.docker.docker_container_exec:
        container: splunk
        user: root
        command: >-
          grep -q "javaHome = {{ splunk_docker_java_container_home }}"
          /opt/splunk/etc/apps/splunk_app_db_connect/local/dbx_settings.conf
      register: splunk_docker_dbconnect_check
      failed_when: false
      when: splunk_docker_java_enabled

    - name: Record DB Connect JAVA_HOME status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'DB Connect JAVA_HOME configured', 'passed': (splunk_docker_dbconnect_check.rc | default(1)) == 0}] }}
      when: splunk_docker_java_enabled

    - name: Check MS SQL JDBC driver is present
      ansible.builtin.stat:
        path: >-
          {{ splunk_docker_etc_dir }}/apps/splunk_app_db_connect/drivers/mssql-jdbc-{{ splunk_docker_mssql_driver_version }}.jar
      register: splunk_docker_mssql_driver_check
      when: splunk_docker_java_enabled and splunk_docker_mssql_driver_enabled | default(false)

    - name: Record MS SQL driver status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'MS SQL JDBC driver installed', 'passed': splunk_docker_mssql_driver_check.stat.exists}] }}
      when: splunk_docker_java_enabled and splunk_docker_mssql_driver_enabled | default(false)

    - name: Get container disk usage
      ansible.builtin.command:
        cmd: df -h /opt/splunk
      register: disk_usage
      changed_when: false
      failed_when: false

    - name: Display validation summary
      ansible.builtin.debug:
        msg: |
          ==========================================
          SPLUNK DOCKER VALIDATION RESULTS
          ==========================================
          {% for result in validation_results %}
          [{{ 'PASS' if result.passed else 'FAIL' }}] {{ result.check }}
          {% endfor %}
          ==========================================

          Disk Usage (Splunk volume):
          {{ disk_usage.stdout | default('Unable to retrieve disk info') }}

    - name: Fail if any validation failed
      ansible.builtin.fail:
        msg: "One or more validation checks failed. Review the results above."
      when: validation_results | selectattr('passed', 'equalto', false) | list | length > 0
