---
# Validation playbook to verify Splunk Docker deployment
# Run this after deploy.yml to verify success
#
# Usage:
#   doppler run -- uv run ansible-playbook playbooks/validate.yml

- name: Load Terraform inventory
  ansible.builtin.import_playbook: ../inventory/load_terraform.yml

- name: Validate Splunk Docker deployment
  hosts: splunk
  become: true
  gather_facts: true

  vars_files:
    - ../roles/splunk_docker/defaults/main.yml

  vars:
    validation_results: []

  tasks:
    - name: Check Docker service is running
      ansible.builtin.service_facts:

    - name: Record Docker service status
      ansible.builtin.set_fact:
        validation_results: |
          {% set svc = ansible_facts.services.get('docker.service', {}).get('state') | default('') %}
          {{ validation_results + [{'check': 'Docker service running', 'passed': svc in ['running', 'started']}] }}

    - name: Check Splunk container is running
      community.docker.docker_container_info:
        name: splunk
      register: splunk_container
      failed_when: false

    - name: Record container status
      ansible.builtin.set_fact:
        validation_results: |
          {{ validation_results + [{'check': 'Splunk container running', 'passed': splunk_container.container.State.Running | default(false)}] }}

    - name: Check docker-compose.yml exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_config_dir }}/docker-compose.yml"
      register: compose_file

    - name: Record docker-compose.yml status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'docker-compose.yml exists', 'passed': compose_file.stat.exists}] }}"

    - name: Check HEC port is listening
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_hec_port }}"
        timeout: 5
      register: hec_port
      failed_when: false

    - name: Record HEC port status
      vars:
        hec_check: "HEC port {{ splunk_docker_hec_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': hec_check, 'passed': hec_port.failed is false}] }}

    - name: Check Splunk web interface
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_web_port }}"
        timeout: 5
      register: web_port
      failed_when: false

    - name: Record web interface status
      vars:
        web_check: "Web port {{ splunk_docker_web_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': web_check, 'passed': web_port.failed is false}] }}

    - name: Check management API port is listening
      ansible.builtin.wait_for:
        port: "{{ splunk_docker_mgmt_port }}"
        timeout: 5
      register: mgmt_port
      failed_when: false

    - name: Record management port status
      vars:
        mgmt_check: "Management API port {{ splunk_docker_mgmt_port }} listening"
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': mgmt_check, 'passed': mgmt_port.failed is false}] }}


    - name: Test HEC endpoint with POST
      ansible.builtin.uri:
        url: "http://localhost:{{ splunk_docker_hec_port }}/services/collector/event"
        method: POST
        headers:
          Authorization: "Splunk {{ lookup('env', 'SPLUNK_HEC_TOKEN') }}"
        body_format: json
        body:
          event: "ansible-validation-test"
          sourcetype: "_json"
          index: "main"
        status_code: 200
      register: hec_test
      failed_when: false
      when: lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0
      no_log: true

    - name: Record HEC POST test status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'HEC POST test', 'passed': (hec_test.status | default(0)) == 200}] }}
      when: lookup('env', 'SPLUNK_HEC_TOKEN') | length > 0

    - name: Check web.conf exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/system/local/web.conf"
      register: web_conf

    - name: Record web.conf status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'web.conf configured', 'passed': web_conf.stat.exists}] }}"

    - name: Check indexes.conf exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_etc_dir }}/system/local/indexes.conf"
      register: indexes_conf

    - name: Record indexes.conf status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'indexes.conf configured', 'passed': indexes_conf.stat.exists}] }}"

    - name: Check firewall.sh exists
      ansible.builtin.stat:
        path: "{{ splunk_docker_config_dir }}/firewall.sh"
      register: firewall_script
      when: splunk_docker_firewall_enabled | default(false)

    - name: Record firewall status
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results + [{'check': 'Firewall configured', 'passed': firewall_script.stat.exists}] }}"
      when: splunk_docker_firewall_enabled | default(false)

    - name: Check Java is accessible in Splunk container
      community.docker.docker_container_exec:
        container: splunk
        command: "{{ splunk_docker_java_container_home }}/bin/java -version"
      register: java_check
      failed_when: false
      when: splunk_docker_java_enabled

    - name: Record Java availability status
      ansible.builtin.set_fact:
        validation_results: >-
          {{ validation_results + [{'check': 'Java accessible in container', 'passed': (java_check.rc | default(1)) == 0}] }}
      when: splunk_docker_java_enabled

    - name: Get container disk usage
      ansible.builtin.command:
        cmd: df -h /opt/splunk
      register: disk_usage
      changed_when: false
      failed_when: false

    - name: Display validation summary
      ansible.builtin.debug:
        msg: |
          ==========================================
          SPLUNK DOCKER VALIDATION RESULTS
          ==========================================
          {% for result in validation_results %}
          [{{ 'PASS' if result.passed else 'FAIL' }}] {{ result.check }}
          {% endfor %}
          ==========================================

          Disk Usage (Splunk volume):
          {{ disk_usage.stdout | default('Unable to retrieve disk info') }}

    - name: Fail if any validation failed
      ansible.builtin.fail:
        msg: "One or more validation checks failed. Review the results above."
      when: validation_results | selectattr('passed', 'equalto', false) | list | length > 0
