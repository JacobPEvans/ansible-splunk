---
# App installation tasks
# Installs Splunkbase apps (from registry) and custom add-ons.
# Called from tasks/main.yml via include_tasks.

- name: Load Splunkbase app registry
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/splunkbase_apps.yml"
  when: splunk_docker_apps is not defined

- name: Load custom add-on definitions
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/custom_addons.yml"
  when: splunk_docker_custom_addons is not defined

- name: Ensure Splunk apps directory exists
  ansible.builtin.file:
    path: "{{ splunk_docker_etc_dir }}/apps"
    state: directory
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0755'

# Validate all enabled Splunkbase app archives and custom add-on archives exist
- name: Set combined list of all apps to validate
  ansible.builtin.set_fact:
    splunk_docker_all_apps_to_validate: >-
      {{ (splunk_docker_apps | selectattr('enabled', 'equalto', true) | list)
         + splunk_docker_custom_addons }}

- name: Validate app archives exist
  ansible.builtin.stat:
    path: "{{ role_path }}/files/{{ item.filename }}"
  loop: "{{ splunk_docker_all_apps_to_validate }}"
  loop_control:
    label: "{{ item.name }}"
  register: splunk_docker_archive_stat

- name: Fail if any app archive is missing
  ansible.builtin.fail:
    msg: >
      {% if item.item.splunkbase_id is defined -%}
      Missing app archive: {{ item.item.filename }}
      Download app '{{ item.item.name }}' (Splunkbase ID: {{ item.item.splunkbase_id }})
      and place it in roles/splunk_docker/files/.
      See roles/splunk_docker/files/README.md for download instructions.
      {%- else -%}
      Missing add-on archive: {{ item.item.filename }}
      Place it in roles/splunk_docker/files/.
      See roles/splunk_docker/files/README.md for details.
      {%- endif %}
  loop: "{{ splunk_docker_archive_stat.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when: not item.stat.exists

# Install all enabled apps in dependency order using a two-pass approach:
# pass 1 - no-dep apps (depends_on: []) and custom add-ons
# pass 2 - apps with dependencies (after their deps are installed)
# NOTE: Only single-level dependencies are supported. Transitive deps
# (A -> B -> C) are not handled; all current apps use direct deps only.
- name: Install all enabled apps and add-ons in order
  ansible.builtin.unarchive:
    src: "{{ role_path }}/files/{{ item.filename }}"
    dest: "{{ splunk_docker_etc_dir }}/apps/"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
  loop: >-
    {{ (splunk_docker_apps | selectattr('enabled', 'equalto', true) | selectattr('depends_on', 'equalto', []) | list)
       + splunk_docker_custom_addons
       + (splunk_docker_apps | selectattr('enabled', 'equalto', true) | rejectattr('depends_on', 'equalto', []) | list) }}
  loop_control:
    label: "{{ item.name }}"
  notify: Restart Splunk container

# CRITICAL: Ensure proper ownership after extracting all apps/TAs.
# Splunk container runs as uid 41812; apps must be owned by this user.
- name: Set correct ownership on Splunk apps directory
  ansible.builtin.file:
    path: "{{ splunk_docker_etc_dir }}/apps"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    recurse: true
  notify: Restart Splunk container
