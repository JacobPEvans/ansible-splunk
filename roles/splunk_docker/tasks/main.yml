---
# Check if Docker is already installed to skip installation tasks
- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: splunk_docker_docker_installed
  changed_when: false
  failed_when: false

# Install Docker prerequisites
- name: Install Docker prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    cache_valid_time: 3600
  when: splunk_docker_docker_installed.rc != 0

- name: Create Docker keyring directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when: splunk_docker_docker_installed.rc != 0

- name: Download Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  when: splunk_docker_docker_installed.rc != 0

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc]
      https://download.docker.com/linux/debian
      {{ ansible_facts['distribution_release'] }} stable
    state: present
    filename: docker
  when: splunk_docker_docker_installed.rc != 0

- name: Install Docker packages
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    cache_valid_time: 3600
  when: splunk_docker_docker_installed.rc != 0

- name: Ensure Docker service is running
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true

- name: Install Java runtime for DB Connect
  ansible.builtin.include_tasks: java.yml
  when: splunk_docker_java_enabled

- name: Create Splunk data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0755'
  loop:
    - "{{ splunk_docker_data_dir }}"
    - "{{ splunk_docker_var_dir }}"
    - "{{ splunk_docker_etc_dir }}"
    - "{{ splunk_docker_config_dir }}"

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ splunk_docker_config_dir }}/docker-compose.yml"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0600'
  no_log: true
  notify: Restart Splunk container

- name: Ensure Splunk system/local directory exists
  ansible.builtin.file:
    path: "{{ splunk_docker_etc_dir }}/system/local"
    state: directory
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0755'

- name: Deploy indexes.conf
  ansible.builtin.template:
    src: indexes.conf.j2
    dest: "{{ splunk_docker_etc_dir }}/system/local/indexes.conf"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0644'
  notify: Restart Splunk container

- name: Deploy inputs.conf for HEC configuration
  ansible.builtin.template:
    src: inputs.conf.j2
    dest: "{{ splunk_docker_etc_dir }}/system/local/inputs.conf"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0600'
  no_log: true
  notify: Restart Splunk container

- name: Deploy web.conf for SSL and update checker configuration
  ansible.builtin.template:
    src: web.conf.j2
    dest: "{{ splunk_docker_etc_dir }}/system/local/web.conf"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0644'
  notify: Restart Splunk container

- name: Deploy server.conf for internet access control
  ansible.builtin.template:
    src: server.conf.j2
    dest: "{{ splunk_docker_etc_dir }}/system/local/server.conf"
    owner: "{{ splunk_docker_user }}"
    group: "{{ splunk_docker_group }}"
    mode: '0644'
  notify: Restart Splunk container

- name: Check if Splunk Docker image exists
  community.docker.docker_image_info:
    name: "{{ splunk_docker_image }}"
  register: splunk_docker_image_info

- name: Pull Splunk Docker image
  community.docker.docker_image:
    name: "{{ splunk_docker_image }}"
    source: pull
    state: present
  when: splunk_docker_image_info.images | length == 0

- name: Start Splunk container with docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ splunk_docker_config_dir }}"
    state: present
  register: splunk_docker_compose_result

- name: Wait for Splunk to be ready
  ansible.builtin.include_tasks: wait_for_splunk.yml

- name: Deploy firewall rules
  ansible.builtin.template:
    src: firewall.sh.j2
    dest: "{{ splunk_docker_config_dir }}/firewall.sh"
    owner: root
    group: root
    mode: '0755'
  when: splunk_docker_firewall_enabled
  notify: Apply firewall rules

# Install Splunkbase apps and custom add-ons
- name: Install apps and add-ons
  ansible.builtin.include_tasks: apps.yml
