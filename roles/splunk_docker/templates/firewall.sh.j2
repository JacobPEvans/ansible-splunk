#!/bin/bash
# Splunk VM Firewall Rules
# Generated by Ansible
#
# Purpose: Lock down Splunk VM to RFC1918 networks only
# - NO outbound internet access
# - Inbound only from private networks

set -e

# Flush existing rules
iptables -F INPUT
iptables -F OUTPUT

# --- OUTPUT RULES (block internet) ---

# Allow established connections (responses to allowed inbound)
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow localhost
iptables -A OUTPUT -o lo -j ACCEPT

# Allow all RFC1918 private networks
iptables -A OUTPUT -d 10.0.0.0/8 -j ACCEPT
iptables -A OUTPUT -d 172.16.0.0/12 -j ACCEPT
iptables -A OUTPUT -d 192.168.0.0/16 -j ACCEPT

# BLOCK ALL OTHER OUTBOUND (this blocks internet)
iptables -A OUTPUT -j DROP

# --- INPUT RULES (allow internal only) ---

# Allow established/related
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow localhost
iptables -A INPUT -i lo -j ACCEPT

# Allow SSH from RFC1918 only
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport 22 -j ACCEPT

# Allow Splunk Web UI from RFC1918 only
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport {{ splunk_docker_web_port }} -j ACCEPT
iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport {{ splunk_docker_web_port }} -j ACCEPT
iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport {{ splunk_docker_web_port }} -j ACCEPT

# Allow HEC from RFC1918 only
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport {{ splunk_docker_hec_port }} -j ACCEPT
iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport {{ splunk_docker_hec_port }} -j ACCEPT
iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport {{ splunk_docker_hec_port }} -j ACCEPT

# Drop everything else
iptables -A INPUT -j DROP

# Persist rules
mkdir -p /etc/iptables
iptables-save > /etc/iptables/rules.v4

echo "Firewall rules applied and saved to /etc/iptables/rules.v4"
